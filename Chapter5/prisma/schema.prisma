// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  // 1. 기본 키 및 자동 증가 (bigint -> BigInt)
  id               BigInt    @id @default(autoincrement()) @db.BigInt

  // 2. Not Null & Unique 필드 (varchar -> String)
  name             String    @db.VarChar(100)
  email            String    @unique(map: "email") @db.VarChar(100)
  gender           String    @db.VarChar(10) // 'male/female/other'
  birth            DateTime  @db.DateTime
  phoneNumber      String    @map("phone_number") @db.VarChar(20)
  password         String    @db.VarChar(255)

  // 3. Null 허용 필드 (Null 허용이므로 타입 뒤에 ?를 붙임)
  address          String?   @db.VarChar(255)
  detailAddress    String?   @map("detail_address") @db.VarChar(255)

  // 4. 기본값(Default) 설정 필드
  currentPoints    Int?      @map("current_points") @default(0) @db.Int // int default 0
  status           String?   @default("active") @db.VarChar(20) // varchar(20) default 'active'
  inactiveDate     DateTime? @map("inactive_date") @db.DateTime // datetime null

  // 5. 생성/수정일시 (DB의 제약 회피를 위해 @default(now()) 제거)
  // createdAt 필드에 ? 제거 (DB 스키마가 not null인 경우)
  // DB 원본: created_at timestamp default CURRENT_TIMESTAMP null
  createdAt        DateTime? @map("created_at") @db.Timestamp // NOTE: @default(now()) 제거
  updatedAt        DateTime? @map("updated_at") @updatedAt @db.Timestamp // NOTE: @default(now()) 제거

  // Relationship Fields
  userPreferences  UserFavorCategory[] // UserFavorCategory 관계 (N:M 연결)
  missionAttempts  MissionAttempt[]    // MissionAttempt 관계
  pointHistory     PointHistory[]      // PointHistory 관계
  reviews          Review[]            // Review 관계
  visits           Visit[]             // Visit 관계

  // 테이블 이름 매핑 및 인덱스
  @@index([status], map: "idx_user_status")
  @@map("user")
}

// FoodCategory (DB Table: category)
model FoodCategory {
  // id: int auto_increment primary key
  id               Int                 @id @default(autoincrement()) @db.Int

  // name: varchar(100) not null unique
  name             String              @unique(map: "name") @db.VarChar(100) // '카테고리 이름 (예: 카페, 음식점)'

  // Relationship: FoodCategory를 선호하는 사용자 목록
  userPreferences  UserFavorCategory[]
  stores           Store[]             // Store 관계

  @@map("category") // DB 테이블 이름 매핑
}


// UserFavorCategory (DB Table: user_preferred_category)
model UserFavorCategory {
  // user_id: bigint not null (복합 PK의 일부)
  userId           BigInt    @map("user_id")
  // category_id: int not null (복합 PK의 일부)
  categoryId       Int       @map("category_id")

  // selected_at: datetime default CURRENT_TIMESTAMP null (DB의 제약 회피를 위해 @default(now()) 제거)
  selectedAt       DateTime? @map("selected_at") @db.Timestamp // NOTE: @default(now()) 제거

  // Relationships:
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category         FoodCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  // 복합 기본 키(Composite Primary Key) 설정
  @@id([userId, categoryId])

  // 인덱스 설정
  @@index([categoryId], map: "category_id") // DB 인덱스 이름 매핑

  @@map("user_preferred_category") // DB 테이블 이름 매핑
}

// Region (DB Table: region) - 지역 정보
model Region {
  // id: int auto_increment primary key
  id               Int       @id @default(autoincrement()) @db.Int

  // name: varchar(100) not null unique
  name             String    @unique(map: "name") @db.VarChar(100) // '지역 이름 (예: 강남구)'

  // Relationship Fields
  stores           Store[]
  regionRewards    RegionReward[]

  @@map("region")
}

// Store (DB Table: store) - 가게 기본 정보
model Store {
  // id: bigint auto_increment primary key
  id               BigInt    @id @default(autoincrement()) @db.BigInt

  // Foreign Keys (region_id, category_id)
  regionId         Int       @map("region_id")
  categoryId       Int       @map("category_id")

  // name: varchar(255) not null
  name             String    @db.VarChar(255) // '가게 이름'

  // address: varchar(255) not null
  address          String    @db.VarChar(255) // '가게 주소'

  // phone_number: varchar(20) null
  phoneNumber      String?   @map("phone_number") @db.VarChar(20) // 전화번호는 NULL 허용

  // created_at: timestamp default CURRENT_TIMESTAMP null (DB의 제약 회피를 위해 @default(now()) 제거)
  createdAt        DateTime? @map("created_at") @db.Timestamp // NOTE: @default(now()) 제거

  // Relationship Fields
  region           Region    @relation(fields: [regionId], references: [id])
  category         FoodCategory @relation(fields: [categoryId], references: [id])
  missions         Mission[]
  reviews          Review[]
  visits           Visit[]

  // 인덱스
  @@index([categoryId], map: "category_id")
  @@index([regionId], map: "region_id")

  @@map("store")
}

// Mission (DB Table: mission) - 미션 상세 정보
model Mission {
  // id: bigint auto_increment primary key
  id               BigInt    @id @default(autoincrement()) @db.BigInt

  // store_id: bigint not null
  storeId          BigInt    @map("store_id")

  // min_amount: decimal(10, 2) not null
  minAmount        Decimal   @map("min_amount") @db.Decimal(10, 2) // 정밀한 계산을 위해 Decimal 사용

  // reward_point: int default 0 not null
  rewardPoint      Int       @map("reward_point") @default(0) @db.Int

  // description: text not null
  description      String    @db.Text // TEXT 타입은 Prisma에서 String으로 매핑, @db.Text 지정

  // is_active: tinyint(1) default 1 null
  isActive         Boolean?  @map("is_active") @default(true) @db.TinyInt // tinyint(1)을 Boolean으로 매핑

  // created_at: timestamp default CURRENT_TIMESTAMP null (DB의 제약 회피를 위해 @default(now()) 제거)
  createdAt        DateTime? @map("created_at") @db.Timestamp // NOTE: @default(now()) 제거

  // Relationship Fields
  store            Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  missionAttempts  MissionAttempt[]

  // 인덱스
  @@index([storeId, isActive], map: "idx_mission_store_active")

  @@map("mission")
}

// MissionAttempt (DB Table: mission_attempt) - 회원의 미션 도전 상태
model MissionAttempt {
  // id: bigint auto_increment primary key
  id               BigInt    @id @default(autoincrement()) @db.BigInt

  // Foreign Keys (user_id, mission_id)
  userId           BigInt    @map("user_id")
  missionId        BigInt    @map("mission_id")

  // status: varchar(20) not null
  status           String    @db.VarChar(20) // 'pending', 'requested', 'completed' 등

  // auth_code: varchar(10) null
  authCode         String?   @map("auth_code") @db.VarChar(10)

  // spent_amount: decimal(10, 2) null
  spentAmount      Decimal?  @map("spent_amount") @db.Decimal(10, 2)

  // started_at: datetime default CURRENT_TIMESTAMP null (DB의 제약 회피를 위해 @default(now()) 제거)
  startedAt        DateTime? @map("started_at") @db.Timestamp // NOTE: @default(now()) 제거

  // request_at, approved_at, completed_at: datetime null
  requestAt        DateTime? @map("request_at") @db.DateTime
  approvedAt       DateTime? @map("approved_at") @db.DateTime
  completedAt      DateTime? @map("completed_at") @db.DateTime

  // Relationship Fields
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  mission          Mission   @relation(fields: [missionId], references: [id], onDelete: Cascade)
  review           Review?   // Review 관계 (1:1 유일한 관계)
  visit            Visit?    // Visit 관계 (1:1 유일한 관계)

  // 인덱스
  @@index([userId, status], map: "idx_mission_attempt_user_status")
  @@index([missionId], map: "mission_id")

  @@map("mission_attempt")
}

// PointHistory (DB Table: point_history) - 포인트 적립/차감 상세 내역
model PointHistory {
  // id: bigint auto_increment primary key
  id               BigInt    @id @default(autoincrement()) @db.BigInt

  // user_id: bigint not null
  userId           BigInt    @map("user_id")

  // type: varchar(30) not null
  type             String    @db.VarChar(30) // 'mission_reward', 'visit_reward' 등

  // amount: int not null
  amount           Int       @db.Int // 포인트 양

  // related_table: varchar(50) null
  relatedTable     String?   @map("related_table") @db.VarChar(50) // 'visit', 'mission_attempt' 등

  // related_id: bigint null
  relatedId        BigInt?   @map("related_id") @db.BigInt // 관련 레코드 ID

  // created_at: timestamp default CURRENT_TIMESTAMP null (DB의 제약 회피를 위해 @default(now()) 제거)
  createdAt        DateTime? @map("created_at") @db.Timestamp // NOTE: @default(now()) 제거

  // Relationship Fields
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 인덱스
  @@index([userId], map: "user_id")

  @@map("point_history")
}

// RegionReward (DB Table: region_reward) - 지역별 미션 보상 조건
model RegionReward {
  // id: int auto_increment primary key
  id               Int       @id @default(autoincrement()) @db.Int

  // region_id: int not null
  regionId         Int       @map("region_id")

  // required_store_count: int not null
  requiredStoreCount Int     @map("required_store_count") @db.Int

  // reward_points: int not null
  rewardPoints     Int       @map("reward_points") @db.Int

  // is_active: tinyint(1) default 1 null
  isActive         Boolean?  @map("is_active") @default(true) @db.TinyInt

  // start_date, end_date: date not null
  startDate        DateTime  @map("start_date") @db.Date // DATE 타입은 DateTime에 @db.Date
  endDate          DateTime  @map("end_date") @db.Date

  // created_at: timestamp default CURRENT_TIMESTAMP null (DB의 제약 회피를 위해 @default(now()) 제거)
  createdAt        DateTime? @map("created_at") @db.Timestamp // NOTE: @default(now()) 제거

  // Relationship Fields
  region           Region    @relation(fields: [regionId], references: [id], onDelete: Cascade)

  // 인덱스
  @@index([regionId], map: "region_id")

  @@map("region_reward")
}

// Review (DB Table: review) - 미션 성공 후 리뷰 기록
model Review {
  // id: bigint auto_increment primary key
  id               BigInt    @id @default(autoincrement()) @db.BigInt

  // Foreign Keys (attempt_id, user_id, store_id)
  attemptId        BigInt    @unique(map: "attempt_id") @map("attempt_id") // UNIQUE 제약 조건
  userId           BigInt    @map("user_id")
  storeId          BigInt    @map("store_id")

  // rating: tinyint not null (1~5)
  rating           Int       @db.TinyInt // tinyint를 Int로 매핑

  // content: text null
  content          String?   @db.Text

  // created_at: timestamp default CURRENT_TIMESTAMP null (DB의 제약 회피를 위해 @default(now()) 제거)
  createdAt        DateTime? @map("created_at") @db.Timestamp // NOTE: @default(now()) 제거

  // Relationship Fields
  missionAttempt   MissionAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  store            Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // 인덱스
  @@index([userId, storeId], map: "idx_review_user_store")
  @@index([storeId], map: "store_id")

  // CHECK 제약 조건: Prisma에서는 CHECK 제약 조건을 지원하지 않으므로, 애플리케이션 또는 DB 자체에서 검증 필요
  // check (`rating` between 1 and 5)

  @@map("review")
}

// Visit (DB Table: visit) - 회원의 가게 방문 및 결제 기록
model Visit {
  // id: bigint auto_increment primary key
  id               BigInt    @id @default(autoincrement()) @db.BigInt

  // Foreign Keys (user_id, store_id, attempt_id)
  userId           BigInt    @map("user_id")
  storeId          BigInt    @map("store_id")
  attemptId        BigInt?   @unique(map: "attempt_id") @map("attempt_id") // UNIQUE & NULL 허용

  // visited_at: datetime default CURRENT_TIMESTAMP null (DB의 제약 회피를 위해 @default(now()) 제거)
  visitedAt        DateTime? @map("visited_at") @db.Timestamp // NOTE: @default(now()) 제거

  // spent_amount: decimal(10, 2) not null
  spentAmount      Decimal   @map("spent_amount") @db.Decimal(10, 2)

  // Relationship Fields
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  store            Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  missionAttempt   MissionAttempt? @relation(fields: [attemptId], references: [id], onDelete: SetNull) // on delete set null 반영

  // 인덱스
  @@index([userId, storeId], map: "idx_visit_user_store")
  @@index([storeId], map: "store_id")

  @@map("visit")
}
